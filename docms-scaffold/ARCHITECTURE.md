# Docms 脚手架架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Docms 脚手架项目                          │
│                  (可复用的核心代码)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 使用 CLI 工具
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  生成的站点实例                              │
│               (每个站点独立部署)                             │
└─────────────────────────────────────────────────────────────┘
```

## 核心设计理念

### 1. 分离关注点

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  核心引擎    │    │  站点配置    │    │  站点内容    │
│  (docms/)    │◄───│  (site.yaml) │◄───│  (database)  │
│              │    │              │    │  (templates) │
└──────────────┘    └──────────────┘    └──────────────┘
     │
     │ 应用工厂模式
     ▼
┌──────────────────────────────────────────────────┐
│          FastAPI Application Instance            │
│  (根据配置创建的应用实例)                         │
└──────────────────────────────────────────────────┘
```

**核心引擎（docms/）**：
- 不包含任何站点特定的内容
- 提供可复用的模型、服务、路由
- 通过应用工厂模式创建应用实例

**站点配置（site.yaml）**：
- 站点名称、描述、URL
- 模板目录、静态文件目录
- 数据库连接
- 主题设置

**站点内容**：
- 数据库数据（产品、文章等）
- 模板文件（HTML）
- 静态资源（CSS、JS、图片）

### 2. 应用工厂模式

```python
# docms/app.py
def create_app(site_config: SiteConfig) -> FastAPI:
    """根据配置创建 FastAPI 应用"""
    app = FastAPI(title=site_config.site_name)

    # 将配置存储到 app.state
    app.state.config = site_config
    app.state.template_dir = site_config.template_dir
    app.state.database_url = site_config.database_url

    # 注册路由、中间件等
    register_routes(app)

    return app
```

```python
# 站点入口 (app.py)
from docms import create_app
from docms.config import SiteConfig

config = SiteConfig.from_yaml("site.yaml")
app = create_app(config)
```

### 3. CLI 工具链

```
┌─────────────────┐
│  create_site    │  创建新站点目录结构
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│generate_content │  使用 LLM 生成内容
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  alembic        │  初始化数据库
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   python app.py │  启动服务器
└─────────────────┘
```

## 工作流详解

### 创建站点流程

```
用户运行: python -m cli.create_site --name my-site
                    │
                    ▼
┌────────────────────────────────────────┐
│  1. 创建目录结构                       │
│     - instance/                        │
│     - templates/                       │
│     - migrations/                      │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  2. 复制核心代码                       │
│     - 复制 app/ 目录                   │
│     - 复制 docms/ 目录                 │
│     - 复制 alembic.ini                 │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  3. 创建配置文件                       │
│     - site.yaml                        │
│     - requirements.txt                 │
│     - app.py (入口文件)                │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  4. 创建基础模板                       │
│     - base.html                        │
│     - home.html                        │
│     - 404.html, 500.html               │
│     - main.css                         │
└────────────────────────────────────────┘
```

### LLM 内容生成流程

```
用户运行: python -m cli.generate_content
                    │
                    ▼
┌────────────────────────────────────────┐
│  1. 收集公司信息（交互式问答）         │
│     - 公司名称                         │
│     - 所属行业                         │
│     - 主要产品                         │
│     - 产品分类                         │
│     - 文章分类                         │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  2. 生成提示词                         │
│     - database_prompt.txt              │
│       (数据库内容生成提示词)           │
│     - template_prompt.txt              │
│       (模板文件生成提示词)             │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  3. 用户将提示词发送给 LLM             │
│     Claude / GPT-4 / 其他              │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│  4. 保存 LLM 返回的内容                │
│     - seed_data.sql (数据库脚本)       │
│     - home.html, product_list.html 等  │
└────────────────────────────────────────┘
```

## 提示词设计

### 数据库内容提示词结构

```
┌─────────────────────────────────────────┐
│  公司信息（自动填充）                   │
│  - 公司名称                             │
│  - 所属行业                             │
│  - 主要产品                             │
│  - ...                                  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  需要生成的数据表                       │
│  - site_setting (站点配置)             │
│  - site_column (栏目)                  │
│  - product (产品)                      │
│  - post (文章)                         │
│  - ...                                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  数据要求和约束                         │
│  - 数据量（8-12 个产品）               │
│  - 内容长度（200 字描述）              │
│  - 外键关联要求                        │
│  - 不使用占位文本                      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  输出格式要求                           │
│  - SQL INSERT 语句                     │
│  - 包含清空数据的 DELETE 语句          │
│  - 确保可直接执行                      │
└─────────────────────────────────────────┘
```

### Token 优化策略

**目标**：将单个站点生成控制在 **12,000 tokens** 以内

| 步骤 | 输入 Token | 输出 Token | 总计 |
|------|-----------|-----------|------|
| 数据库提示词 | 1,500 | 3,000 | 4,500 |
| 模板提示词 | 2,000 | 5,000 | 7,000 |
| **总计** | **3,500** | **8,000** | **11,500** |

**优化方法**：
1. 精简提示词语言
2. 减少示例数量
3. 分批生成（先数据库，后模板）
4. 复用成功的提示词

## 部署架构

### 单站点部署

```
┌─────────────────────────────────────────┐
│           Nginx / Caddy                 │
│       (反向代理 + HTTPS)                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         Uvicorn (FastAPI)               │
│          (单个站点实例)                  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│        SQLite Database                  │
│     (instance/database.db)              │
└─────────────────────────────────────────┘
```

### 多站点部署（共享服务器）

```
┌─────────────────────────────────────────┐
│              Nginx                      │
└───┬─────────┬─────────┬─────────────────┘
    │         │         │
    │         │         │
    ▼         ▼         ▼
┌─────┐   ┌─────┐   ┌─────┐
│Site1│   │Site2│   │Site3│
│:8001│   │:8002│   │:8003│
└──┬──┘   └──┬──┘   └──┬──┘
   │         │         │
   ▼         ▼         ▼
┌─────┐   ┌─────┐   ┌─────┐
│ DB1 │   │ DB2 │   │ DB3 │
└─────┘   └─────┘   └─────┘
```

每个站点：
- 独立的端口
- 独立的数据库
- 独立的模板和配置
- 共享核心引擎代码

## 扩展性设计

### 添加新功能

```
1. 修改核心模型 (docms/models/)
   ↓
2. 创建数据库迁移
   alembic revision --autogenerate -m "add feature"
   ↓
3. 更新服务层 (docms/services/)
   ↓
4. 更新路由 (docms/routes/)
   ↓
5. 更新提示词模板（让 LLM 知道新功能）
   ↓
6. 重新生成站点或手动更新现有站点
```

### 多主题支持（未来）

```
site.yaml:
  theme: "green-tech"
  available_themes: ["green-tech", "blue-corp", "red-minimal"]

templates/
  ├── green-tech/
  │   ├── base.html
  │   ├── home.html
  │   └── static/css/main.css
  ├── blue-corp/
  │   └── ...
  └── red-minimal/
      └── ...
```

根据配置动态选择模板目录。

## 技术栈

### 后端
- **FastAPI** - 现代 Python Web 框架
- **SQLAlchemy** - ORM
- **Alembic** - 数据库迁移
- **Pydantic** - 数据验证

### 前端
- **Jinja2** - 模板引擎（SSR）
- **Tailwind CSS** - CSS 框架（可选）
- **Vanilla JS** - 基础交互

### 数据库
- **SQLite** - 开发和小型部署
- **PostgreSQL** - 生产环境（可选）

### 部署
- **Uvicorn** - ASGI 服务器
- **Nginx/Caddy** - 反向代理
- **Docker** - 容器化（可选）

## 总结

Docms 脚手架通过以下设计实现了快速生成企业官网的目标：

1. **核心引擎与站点实例分离** - 可复用性
2. **应用工厂模式** - 灵活配置
3. **LLM 驱动的内容生成** - 低成本、高效率
4. **优化的提示词设计** - 最小化 Token 消耗
5. **CLI 工具链** - 自动化工作流

**时间成本**：15-20 分钟
**Token 成本**：约 11,500 tokens (~$0.15)
**技术门槛**：低（无需编写代码）

适用于：
- 快速交付企业官网项目
- 创建产品原型和演示
- 学习 FastAPI 和现代 Web 开发
