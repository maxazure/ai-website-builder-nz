# -*- coding: utf-8 -*-
"""Generate Content with LLM

ä½¿ç”¨ LLM ç”Ÿæˆç«™ç‚¹å†…å®¹ï¼š
1. æ”¶é›†å…¬å¸ä¿¡æ¯
2. ç”Ÿæˆæç¤ºè¯
3. è®©ç”¨æˆ·å°†æç¤ºè¯å‘é€ç»™ LLM
4. ä¿å­˜ LLM ç”Ÿæˆçš„å†…å®¹

ç”¨æ³•:
    python -m cli.generate_content
"""

import json
import sys
from pathlib import Path
from typing import Dict


def collect_company_info() -> Dict[str, str]:
    """æ”¶é›†å…¬å¸åŸºæœ¬ä¿¡æ¯"""
    print("=" * 60)
    print("  Docms å†…å®¹ç”Ÿæˆå·¥å…· - ä½¿ç”¨ LLM å¿«é€Ÿåˆ›å»ºä¼ä¸šç«™ç‚¹")
    print("=" * 60)
    print()
    print("è¯·æä¾›ä»¥ä¸‹å…¬å¸ä¿¡æ¯ï¼ˆå°†ç”¨äºç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹ï¼‰ï¼š")
    print()

    info = {}

    info["company_name"] = input("å…¬å¸åç§°: ").strip()
    info["industry"] = input("æ‰€å±è¡Œä¸šï¼ˆå¦‚: æ™ºèƒ½æ°´åŸ¹è®¾å¤‡ã€è½¯ä»¶å¼€å‘ç­‰ï¼‰: ").strip()
    info["main_products"] = input("ä¸»è¦äº§å“/æœåŠ¡ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰: ").strip()
    info["company_description"] = input("å…¬å¸ç®€ä»‹ï¼ˆä¸€å¥è¯ï¼‰: ").strip()
    info["target_customers"] = input("ç›®æ ‡å®¢æˆ·ï¼ˆå¦‚: å®¶åº­ç”¨æˆ·ã€ä¼ä¸šå®¢æˆ·ç­‰ï¼‰: ").strip()
    info["product_categories"] = input("äº§å“åˆ†ç±»ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å®¶ç”¨è®¾å¤‡ã€å•†ç”¨è®¾å¤‡ï¼‰: ").strip()
    info["post_categories"] = input("æ–‡ç« åˆ†ç±»ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚: è¡Œä¸šåŠ¨æ€ã€æŠ€æœ¯æ–‡æ¡£ï¼‰: ").strip()

    print()
    print("æ”¶é›†å®Œæˆï¼")
    return info


def generate_database_prompt(info: Dict[str, str]) -> str:
    """ç”Ÿæˆæ•°æ®åº“å†…å®¹ç”Ÿæˆæç¤ºè¯"""
    prompt = f"""# ä»»åŠ¡ï¼šä¸ºä¼ä¸šå®˜ç½‘ç”Ÿæˆ SQLite æ•°æ®åº“å¡«å……è„šæœ¬

## å…¬å¸ä¿¡æ¯
- å…¬å¸åç§°ï¼š{info['company_name']}
- æ‰€å±è¡Œä¸šï¼š{info['industry']}
- ä¸»è¦äº§å“/æœåŠ¡ï¼š{info['main_products']}
- å…¬å¸ç®€ä»‹ï¼š{info['company_description']}
- ç›®æ ‡å®¢æˆ·ï¼š{info['target_customers']}
- äº§å“åˆ†ç±»ï¼š{info['product_categories']}
- æ–‡ç« åˆ†ç±»ï¼š{info['post_categories']}

## è¦æ±‚

è¯·ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ SQL è„šæœ¬ï¼ˆseed_data.sqlï¼‰ï¼Œç”¨äºå¡«å……ä»¥ä¸‹æ•°æ®åº“è¡¨ï¼š

### 1. site_settingï¼ˆç«™ç‚¹é…ç½®ï¼‰
æ’å…¥ä»¥ä¸‹é…ç½®é¡¹ï¼š
- site_name: {info['company_name']}
- site_description: {info['company_description']}
- phone: ç”Ÿæˆä¸€ä¸ªåˆç†çš„ç”µè¯å·ç 
- email: ç”Ÿæˆä¸€ä¸ªåˆç†çš„é‚®ç®±
- address: ç”Ÿæˆä¸€ä¸ªåˆç†çš„åœ°å€
- about_us: ç”Ÿæˆä¸€æ®µ 200 å­—å·¦å³çš„å…¬å¸ä»‹ç»

### 2. site_columnï¼ˆæ ç›®ï¼‰
åˆ›å»ºä»¥ä¸‹æ ç›®ï¼š
- é¦–é¡µï¼ˆslug: home, type: CUSTOMï¼‰
- äº§å“ä¸­å¿ƒï¼ˆslug: products, type: PRODUCTï¼‰
- æ–°é—»èµ„è®¯ï¼ˆslug: news, type: POSTï¼‰
- å…³äºæˆ‘ä»¬ï¼ˆslug: about, type: SINGLE_PAGEï¼‰
- è”ç³»æˆ‘ä»¬ï¼ˆslug: contact, type: SINGLE_PAGEï¼‰

### 3. single_pageï¼ˆå•é¡µå†…å®¹ï¼‰
ä¸º"å…³äºæˆ‘ä»¬"å’Œ"è”ç³»æˆ‘ä»¬"æ ç›®ç”Ÿæˆå†…å®¹ï¼ˆHTMLæ ¼å¼ï¼‰

### 4. product_categoryï¼ˆäº§å“åˆ†ç±»ï¼‰
æ ¹æ® "{info['product_categories']}" åˆ›å»º 3-5 ä¸ªäº§å“åˆ†ç±»

### 5. productï¼ˆäº§å“ï¼‰
åˆ›å»º 8-12 ä¸ªäº§å“ï¼Œè¦æ±‚ï¼š
- åç§°è¦ç¬¦åˆ {info['industry']} è¡Œä¸šç‰¹ç‚¹
- æ¯ä¸ªäº§å“åŒ…å«ï¼šname, slug, summaryï¼ˆ50å­—ï¼‰, description_htmlï¼ˆ200å­—HTMLï¼‰
- ä»·æ ¼èŒƒå›´åˆç†
- è‡³å°‘ 3 ä¸ªäº§å“è®¾ç½®ä¸ºæ¨èï¼ˆis_recommended=1ï¼‰
- çŠ¶æ€éƒ½è®¾ä¸º online
- æ¯ä¸ªäº§å“å…³è”è‡³å°‘ä¸€ä¸ªåˆ†ç±»

### 6. post_categoryï¼ˆæ–‡ç« åˆ†ç±»ï¼‰
æ ¹æ® "{info['post_categories']}" åˆ›å»º 3-5 ä¸ªæ–‡ç« åˆ†ç±»

### 7. postï¼ˆæ–‡ç« ï¼‰
åˆ›å»º 6-10 ç¯‡æ–‡ç« ï¼Œè¦æ±‚ï¼š
- æ ‡é¢˜ä¸ {info['industry']} ç›¸å…³
- æ¯ç¯‡æ–‡ç« åŒ…å«ï¼štitle, slug, summaryï¼ˆ100å­—ï¼‰, content_htmlï¼ˆ300-500å­—HTMLï¼‰
- è‡³å°‘ 3 ç¯‡è®¾ç½®ä¸ºæ¨èï¼ˆis_recommended=1ï¼‰
- çŠ¶æ€éƒ½è®¾ä¸º published
- æ¯ç¯‡æ–‡ç« å…³è”è‡³å°‘ä¸€ä¸ªåˆ†ç±»

## è¾“å‡ºæ ¼å¼

ç”Ÿæˆä¸€ä¸ªå¯ç›´æ¥æ‰§è¡Œçš„ SQL è„šæœ¬ï¼ŒåŒ…å«æ‰€æœ‰ INSERT è¯­å¥ã€‚

SQL è„šæœ¬å¼€å¤´æ·»åŠ ï¼š
```sql
-- Generated by Docms Content Generator
-- Company: {info['company_name']}
-- Date: {{{{ current_date }}}}

-- æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¯é€‰ï¼‰
DELETE FROM product_category_link;
DELETE FROM post_category_link;
DELETE FROM product;
DELETE FROM post;
DELETE FROM product_category;
DELETE FROM post_category;
DELETE FROM single_page;
DELETE FROM site_column;
DELETE FROM site_setting;
```

è¯·ç¡®ä¿ï¼š
1. æ‰€æœ‰å†…å®¹çœŸå®ã€åˆç†ã€ä¸“ä¸š
2. HTML å†…å®¹æ ¼å¼æ­£ç¡®ï¼Œä½¿ç”¨ <p>, <h2>, <ul> ç­‰æ ‡ç­¾
3. slug ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦
4. å¤–é”®å…³è”æ­£ç¡®
5. ä¸è¦ä½¿ç”¨ Lorem Ipsum å ä½æ–‡æœ¬

å¼€å§‹ç”Ÿæˆ SQL è„šæœ¬ï¼š
"""
    return prompt


def generate_template_prompt(info: Dict[str, str]) -> str:
    """ç”Ÿæˆæ¨¡æ¿ç”Ÿæˆæç¤ºè¯"""
    prompt = f"""# ä»»åŠ¡ï¼šä¸ºä¼ä¸šå®˜ç½‘ç”Ÿæˆ Jinja2 æ¨¡æ¿æ–‡ä»¶

## å…¬å¸ä¿¡æ¯
- å…¬å¸åç§°ï¼š{info['company_name']}
- æ‰€å±è¡Œä¸šï¼š{info['industry']}
- å…¬å¸ç®€ä»‹ï¼š{info['company_description']}

## è¦æ±‚

è¯·ç”Ÿæˆä»¥ä¸‹ Jinja2 æ¨¡æ¿æ–‡ä»¶ï¼Œé£æ ¼è¦ç¬¦åˆ {info['industry']} è¡Œä¸šç‰¹ç‚¹ï¼š

### 1. home.htmlï¼ˆé¦–é¡µï¼‰
- ç»§æ‰¿ base.html
- åŒ…å« hero åŒºåŸŸï¼Œå±•ç¤ºå…¬å¸ slogan
- å±•ç¤ºæ¨èäº§å“ï¼ˆä½¿ç”¨ featured_products å˜é‡ï¼‰
- å±•ç¤ºæœ€æ–°æ–‡ç« ï¼ˆä½¿ç”¨ featured_posts å˜é‡ï¼‰
- é£æ ¼ï¼šç°ä»£ã€ä¸“ä¸šã€ç®€æ´

### 2. product_list.htmlï¼ˆäº§å“åˆ—è¡¨é¡µï¼‰
- ç»§æ‰¿ base.html
- å·¦ä¾§ï¼šäº§å“åˆ†ç±»å¯¼èˆªï¼ˆä½¿ç”¨ categories å˜é‡ï¼‰
- å³ä¾§ï¼šäº§å“ç½‘æ ¼å¸ƒå±€ï¼ˆä½¿ç”¨ products å˜é‡ï¼‰
- æ¯ä¸ªäº§å“å¡ç‰‡æ˜¾ç¤ºï¼šå›¾ç‰‡ã€åç§°ã€ç®€ä»‹ã€ä»·æ ¼ã€æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®

### 3. product_detail.htmlï¼ˆäº§å“è¯¦æƒ…é¡µï¼‰
- ç»§æ‰¿ base.html
- å·¦ä¾§ï¼šäº§å“å›¾ç‰‡
- å³ä¾§ï¼šäº§å“ä¿¡æ¯ï¼ˆåç§°ã€ä»·æ ¼ã€ç®€ä»‹ï¼‰
- ä¸‹æ–¹ï¼šäº§å“è¯¦ç»†æè¿°ï¼ˆHTMLï¼‰
- ç›¸å…³äº§å“æ¨èï¼ˆä½¿ç”¨ related_products å˜é‡ï¼‰

### 4. post_list.htmlï¼ˆæ–‡ç« åˆ—è¡¨é¡µï¼‰
- ç»§æ‰¿ base.html
- æ–‡ç« åˆ—è¡¨ï¼ˆä½¿ç”¨ posts å˜é‡ï¼‰
- ä¾§è¾¹æ ï¼šåˆ†ç±»å¯¼èˆªã€çƒ­é—¨æ–‡ç« 

### 5. post_detail.htmlï¼ˆæ–‡ç« è¯¦æƒ…é¡µï¼‰
- ç»§æ‰¿ base.html
- æ–‡ç« æ ‡é¢˜ã€å‘å¸ƒæ—¥æœŸã€å†…å®¹
- ç›¸å…³æ–‡ç« æ¨è

### 6. about.htmlï¼ˆå…³äºæˆ‘ä»¬ï¼‰
- ç»§æ‰¿ base.html
- å±•ç¤ºå…¬å¸ä»‹ç»ã€å›¢é˜Ÿã€å‘å±•å†ç¨‹

### 7. contact.htmlï¼ˆè”ç³»æˆ‘ä»¬ï¼‰
- ç»§æ‰¿ base.html
- è”ç³»è¡¨å•ï¼ˆå§“åã€é‚®ç®±ã€ç”µè¯ã€ä¸»é¢˜ã€ç•™è¨€ï¼‰
- è”ç³»æ–¹å¼å±•ç¤ºï¼ˆç”µè¯ã€é‚®ç®±ã€åœ°å€ï¼‰

## æŠ€æœ¯è¦æ±‚
- ä½¿ç”¨ Tailwind CSS ç±»åï¼ˆå·²åœ¨ base.html ä¸­å¼•å…¥ï¼‰
- å“åº”å¼è®¾è®¡
- ç°ä»£åŒ–çš„ UI é£æ ¼
- é¢œè‰²ä¸»é¢˜ï¼šæ ¹æ® {info['industry']} è¡Œä¸šé€‰æ‹©åˆé€‚çš„ä¸»è‰²è°ƒ

## è¾“å‡ºæ ¼å¼
ä¸ºæ¯ä¸ªæ¨¡æ¿æ–‡ä»¶ç”Ÿæˆå®Œæ•´çš„ HTML ä»£ç ï¼ŒåŒ…å«æ–‡ä»¶åæ³¨é‡Šã€‚

å¼€å§‹ç”Ÿæˆæ¨¡æ¿ï¼š
"""
    return prompt


def save_prompt_to_file(prompt: str, filename: str):
    """ä¿å­˜æç¤ºè¯åˆ°æ–‡ä»¶"""
    prompt_dir = Path("prompts")
    prompt_dir.mkdir(exist_ok=True)

    file_path = prompt_dir / filename
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(prompt)

    print(f"  âœ“ æç¤ºè¯å·²ä¿å­˜åˆ°: {file_path}")


def save_generated_content(content_type: str):
    """ä¿å­˜ LLM ç”Ÿæˆçš„å†…å®¹"""
    print()
    print("=" * 60)
    print(f"  ä¿å­˜ {content_type} å†…å®¹")
    print("=" * 60)
    print()
    print("è¯·å°† LLM ç”Ÿæˆçš„å†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹ï¼ˆè¾“å…¥ '###END###' ç»“æŸï¼‰ï¼š")
    print()

    lines = []
    while True:
        try:
            line = input()
            if line.strip() == "###END###":
                break
            lines.append(line)
        except EOFError:
            break

    content = "\n".join(lines)

    if content_type == "æ•°æ®åº“è„šæœ¬":
        file_path = Path("seed_data.sql")
    elif content_type == "æ¨¡æ¿æ–‡ä»¶":
        # è¯¢é—®æ–‡ä»¶å
        filename = input("è¯·è¾“å…¥æ–‡ä»¶åï¼ˆå¦‚ home.htmlï¼‰: ").strip()
        file_path = Path("templates") / filename
        file_path.parent.mkdir(parents=True, exist_ok=True)
    else:
        return

    with open(file_path, "w", encoding="utf-8") as f:
        f.write(content)

    print()
    print(f"âœ“ å†…å®¹å·²ä¿å­˜åˆ°: {file_path}")


def main():
    """ä¸»æµç¨‹"""
    # æ£€æŸ¥æ˜¯å¦åœ¨ç«™ç‚¹ç›®å½•ä¸­
    if not Path("site.yaml").exists():
        print("âŒ é”™è¯¯: è¯·åœ¨ç«™ç‚¹ç›®å½•ä¸­è¿è¡Œæ­¤å‘½ä»¤")
        print("æç¤º: å…ˆä½¿ç”¨ 'python -m cli.create_site' åˆ›å»ºç«™ç‚¹")
        sys.exit(1)

    print()
    print("ğŸ¤– Docms æ™ºèƒ½å†…å®¹ç”Ÿæˆå™¨")
    print()
    print("æ­¤å·¥å…·å°†å¸®åŠ©ä½ ä½¿ç”¨ LLM ç”Ÿæˆä»¥ä¸‹å†…å®¹ï¼š")
    print("  1. æ•°æ®åº“å¡«å……è„šæœ¬ï¼ˆäº§å“ã€æ–‡ç« ç­‰ï¼‰")
    print("  2. é¡µé¢æ¨¡æ¿æ–‡ä»¶ï¼ˆHTMLï¼‰")
    print()
    print("å·¥ä½œæµç¨‹ï¼š")
    print("  â†’ æ”¶é›†å…¬å¸ä¿¡æ¯")
    print("  â†’ ç”Ÿæˆ LLM æç¤ºè¯")
    print("  â†’ å°†æç¤ºè¯å‘é€ç»™ LLMï¼ˆå¦‚ Claudeã€GPT-4ï¼‰")
    print("  â†’ ä¿å­˜ LLM è¿”å›çš„å†…å®¹")
    print()

    # æ”¶é›†å…¬å¸ä¿¡æ¯
    info = collect_company_info()

    print()
    print("=" * 60)
    print("  ç”Ÿæˆæç¤ºè¯")
    print("=" * 60)

    # ç”Ÿæˆæ•°æ®åº“æç¤ºè¯
    print()
    print("ğŸ“ ç”Ÿæˆæ•°æ®åº“å†…å®¹æç¤ºè¯...")
    db_prompt = generate_database_prompt(info)
    save_prompt_to_file(db_prompt, "database_prompt.txt")

    # ç”Ÿæˆæ¨¡æ¿æç¤ºè¯
    print()
    print("ğŸ“ ç”Ÿæˆæ¨¡æ¿å†…å®¹æç¤ºè¯...")
    template_prompt = generate_template_prompt(info)
    save_prompt_to_file(template_prompt, "template_prompt.txt")

    print()
    print("=" * 60)
    print("  ä¸‹ä¸€æ­¥")
    print("=" * 60)
    print()
    print("æç¤ºè¯å·²ç”Ÿæˆï¼è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š")
    print()
    print("1. æ‰“å¼€ prompts/database_prompt.txt")
    print("2. å°†å†…å®¹å¤åˆ¶å¹¶å‘é€ç»™ LLMï¼ˆå¦‚ Claudeã€GPT-4ï¼‰")
    print("3. å°† LLM è¿”å›çš„ SQL è„šæœ¬ä¿å­˜ä¸º seed_data.sql")
    print()
    print("4. æ‰“å¼€ prompts/template_prompt.txt")
    print("5. å°†å†…å®¹å¤åˆ¶å¹¶å‘é€ç»™ LLM")
    print("6. å°† LLM è¿”å›çš„æ¯ä¸ªæ¨¡æ¿ä¿å­˜åˆ° templates/ ç›®å½•")
    print()
    print("7. åˆå§‹åŒ–æ•°æ®åº“ï¼š")
    print("   alembic upgrade head")
    print("   sqlite3 instance/database.db < seed_data.sql")
    print()
    print("8. å¯åŠ¨æœåŠ¡å™¨ï¼š")
    print("   python app.py")
    print()
    print("ğŸ’¡ æç¤ºï¼šä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤å·¥å…·çš„äº¤äº’å¼ä¿å­˜åŠŸèƒ½")

    # è¯¢é—®æ˜¯å¦ç«‹å³ä¿å­˜å†…å®¹
    print()
    choice = input("æ˜¯å¦ç°åœ¨ä¿å­˜ LLM ç”Ÿæˆçš„å†…å®¹ï¼Ÿ(y/n): ").strip().lower()

    if choice == "y":
        while True:
            print()
            print("é€‰æ‹©è¦ä¿å­˜çš„å†…å®¹ç±»å‹ï¼š")
            print("  1. æ•°æ®åº“è„šæœ¬")
            print("  2. æ¨¡æ¿æ–‡ä»¶")
            print("  3. é€€å‡º")
            print()
            choice = input("è¯·é€‰æ‹© (1-3): ").strip()

            if choice == "1":
                save_generated_content("æ•°æ®åº“è„šæœ¬")
            elif choice == "2":
                save_generated_content("æ¨¡æ¿æ–‡ä»¶")
            elif choice == "3":
                break

    print()
    print("âœ… å®Œæˆï¼ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        sys.exit(1)
