# Docms 全自动网站生成系统设计方案

## 📋 系统分析

### 当前状况

**Scaffold 系统** (docms-scaffold/):
- ✅ 完整的 FastAPI + SQLAlchemy 架构
- ✅ 20个核心模块已全部实现
- ✅ 新的模块化生成器 `create_project_modular.py`
- ✅ 8个行业预设方案 (corporate, ecommerce, education, restaurant, medical, service, minimal, full)
- ✅ 模块配置文件 `modules_config.yaml`
- ✅ 自动依赖解析

**现有 .claude 配置**:
- ✅ 3个Agent (website_planner, website_developer, website_tester)
- ⚠️  1个Command (auto-website) - 引用不存在的文件
- ✅ 1个Hook (test_checker.py)

**存在问题**:
1. `auto-website.md` 引用不存在的 `cli/create_site.py`
2. 未集成新的模块化系统
3. 没有模块选择功能
4. 未利用 modules_config.yaml 和预设方案

---

## 🎯 新系统设计

### 核心理念

**完全自动化的模块化网站生成流程**:
```
用户输入行业描述
    → 自动选择模块方案
    → 创建模块化项目
    → AI规划内容和图片
    → 生成代码和数据
    → 测试验证
    → 交付完整网站
```

### 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    /auto-website 命令                    │
│                   (新版 - 完全重写)                      │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   Planner    │   │  Developer   │   │    Tester    │
│   Agent      │   │    Agent     │   │    Agent     │
│  (更新版本)   │   │  (更新版本)   │   │   (保持)     │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
   规划文档           SQL + 模板          测试报告
```

---

## 📦 详细设计

### Phase 0: 需求分析与模块选择

**输入**: 用户提供行业描述 + 特殊需求

**处理流程**:
1. 分析行业类型关键词:
   - 企业/公司 → corporate
   - 商店/电商/购物 → ecommerce
   - 学校/培训/教育 → education
   - 餐厅/咖啡/食品 → restaurant
   - 医疗/诊所/健康 → medical
   - 律师/会计/咨询 → service

2. 分析特殊需求:
   - 需要预约 → 添加 booking 模块
   - 需要会员 → 添加 user 模块
   - 需要视频 → 添加 video 模块
   - 需要下载 → 添加 file_download 模块

3. 确定最终模块列表

**输出**:
- 选择的 preset 名称 或 自定义模块列表
- 保存到 `SELECTED_MODULES.md`

---

### Phase 1: 创建项目结构

**使用**: `docms-scaffold/create_project_modular.py`

**执行**:
```bash
cd docms-scaffold
python create_project_modular.py <项目名> --preset <preset_name>
# 或
python create_project_modular.py <项目名> --modules <module1>,<module2>,...
```

**结果**:
- 创建完整项目目录
- 只包含选择的模块文件
- 自动生成 __init__.py
- 创建 enabled_modules.txt 记录

---

### Phase 2: 内容与图片规划

**Agent**: `website_planner` (更新版)

**职责**:
1. 读取 `enabled_modules.txt` 了解已启用模块
2. 根据模块规划内容结构:
   - 有 post → 规划新闻/博客内容
   - 有 product → 规划产品/服务
   - 有 team → 规划团队成员
   - 有 portfolio → 规划案例展示
   - 有 event → 规划活动
   - 等等...
3. 设计AI图片生成方案
4. 规划数据库 Schema (基于已启用模块)
5. 设计模板结构

**生成文档**:
- `WEBSITE_REQUIREMENTS.md` - 需求文档
- `CONTENT_PLAN.md` - 内容规划
- `IMAGE_GENERATION_PLAN.md` - 图片方案
- `DATABASE_SCHEMA.md` - 数据库设计
- `TEMPLATE_PLAN.md` - 模板设计
- `TODOS.md` - 任务清单

---

### Phase 3: AI 图片生成

**使用**: Zhipu AI CogView-3

**处理**:
- 读取 `IMAGE_GENERATION_PLAN.md`
- 调用 Zhipu API 生成图片
- 保存到 `instance/media/` 目录
- 更新图片路径记录

---

### Phase 4: 代码与数据生成

**Agent**: `website_developer` (更新版)

**职责**:
1. **读取模块信息**:
   - 从 `enabled_modules.txt` 获取启用的模块
   - 从 `modules_config.yaml` 获取模块定义

2. **生成模块化 SQL**:
   - 只为启用的模块生成 INSERT 语句
   - 示例: 如果启用了 product 模块:
     ```sql
     -- 产品分类
     INSERT INTO product_category (name, slug, description) VALUES
     ('课程', 'courses', '语言培训课程'),
     ...;

     -- 产品
     INSERT INTO product (title, slug, category_id, ...) VALUES
     ('IELTS雅思课程', 'ielts-course', 1, ...),
     ...;
     ```
   - 如果没启用 team 模块 → 不生成团队数据
   - 如果没启用 event 模块 → 不生成活动数据

3. **生成 Jinja2 模板**:
   - 基于启用模块生成对应页面
   - home.html (必需)
   - about.html (必需)
   - contact.html (必需)
   - product_list.html (如果有 product 模块)
   - product_detail.html (如果有 product 模块)
   - post_list.html (如果有 post 模块)
   - post_detail.html (如果有 post 模块)
   - team.html (如果有 team 模块)
   - events.html (如果有 event 模块)
   - 等等...

4. **更新导航菜单**:
   - 根据启用模块动态生成导航链接
   - base.html 中的导航栏只包含已启用模块的页面

**生成文件**:
- `seed_data.sql` - 模块化的种子数据
- `templates/*.html` - Jinja2 模板文件
- `templates/static/css/style.css` - 样式文件

---

### Phase 5: 数据库初始化

**执行步骤**:
```bash
cd <project_name>

# 1. 创建虚拟环境并安装依赖
python -m venv venv
venv\Scripts\activate  # Windows
pip install -r requirements.txt

# 2. 运行数据库迁移
alembic upgrade head

# 3. 导入种子数据
sqlite3 instance/database.db < seed_data.sql
# 或 (如果使用 PostgreSQL)
psql -U user -d database < seed_data.sql
```

---

### Phase 6: 测试验证

**Agent**: `website_tester` (保持不变)

**使用工具**: Chrome DevTools MCP

**测试项目**:
1. ✅ 网站可访问性
2. ✅ 所有页面无404错误
3. ✅ 图片正常加载
4. ✅ 链接有效
5. ✅ 移动端响应式
6. ✅ 表单功能
7. ✅ 导航栏完整

**生成**:
- `TEST_REPORT.md` - 测试报告
- 更新 `TODOS.md` - 标记通过/失败的项目

---

### Phase 7: 修复与迭代

**流程**:
```
if 测试失败:
    分析失败原因
    → 更新代码/模板/数据
    → 重新运行测试
    → 重复直到测试通过
else:
    标记项目完成
    生成交付文档
```

---

### Phase 8: 交付

**生成文档**:
- `DELIVERY.md` - 交付说明
  - 启用的模块列表
  - 功能清单
  - 访问地址
  - 管理员账号
  - 部署说明
  - 后续维护建议

---

## 🔧 需要创建/更新的文件

### 1. 删除
- [ ] `.claude/commands/auto-website.md` (旧版本)

### 2. 创建
- [ ] `.claude/commands/auto-website.md` (全新版本)
- [ ] `tools/全自动网站生成系统设计方案.md` (本文档)

### 3. 更新
- [ ] `.claude/agents/website_planner.md`
  - 添加模块选择逻辑
  - 读取 enabled_modules.txt
  - 根据模块规划内容

- [ ] `.claude/agents/website_developer.md`
  - 添加模块感知能力
  - 动态生成模块化 SQL
  - 只创建需要的模板

### 4. 保持
- [x] `.claude/agents/website_tester.md` (无需修改)
- [x] `.claude/hooks/test_checker.py` (无需修改)

---

## 💡 使用示例

### 示例 1: 创建企业官网

**用户输入**:
```
/auto-website 一家新西兰IT咨询公司的官方网站,需要展示团队、案例、服务和新闻
```

**系统处理**:
1. 分析: IT咨询 → service preset
2. 检测需求: 团队 ✓, 案例 ✓, 服务 ✓, 新闻 ✓
3. 最终模块: post, team, portfolio, product, faq, booking, file_download
4. 创建项目: `python create_project_modular.py it-consulting-nz --preset service`
5. 规划内容: 5篇新闻, 8个团队成员, 6个案例, 12个服务
6. 生成图片: 团队照片、案例截图、服务图标
7. 生成代码: SQL + 7个模板文件
8. 测试通过: ✅

**交付**: 完整的IT咨询公司网站

---

### 示例 2: 创建在线商城

**用户输入**:
```
/auto-website 新西兰手工艺品在线商城,需要购物车、订单管理和会员系统
```

**系统处理**:
1. 分析: 商城 → ecommerce preset
2. 最终模块: product, custom_field, user, cart, order, comment, newsletter, gallery
3. 创建项目: `python create_project_modular.py handcraft-shop-nz --preset ecommerce`
4. 规划内容: 30个产品, 5个分类, 用户系统
5. 生成图片: 产品照片
6. 生成代码: 完整电商功能
7. 测试通过: ✅

**交付**: 功能完整的电商网站

---

### 示例 3: 创建教育网站

**用户输入**:
```
/auto-website Browns Bay语言学校网站,需要课程展示、教师介绍、在线报名和视频教学
```

**系统处理**:
1. 分析: 学校 → education preset
2. 额外需求: 视频 ✓
3. 最终模块: post, team, product(课程), faq, user, booking, event, video, file_download
4. 创建项目: `python create_project_modular.py brownsbay-language-school --preset education`
5. 规划内容: 8个课程, 6个教师, 活动, 教学视频
6. 生成图片: 教师照片、校园照片
7. 生成代码: 完整教育网站
8. 测试通过: ✅

**交付**: 功能齐全的教育网站

---

## 📊 对比分析

### 旧系统 vs 新系统

| 对比项 | 旧系统 | 新系统 |
|-------|--------|--------|
| 模块支持 | ❌ 固定所有模块 | ✅ 8个预设 + 自定义 |
| 项目创建 | ⚠️  引用不存在文件 | ✅ 使用 create_project_modular.py |
| 数据生成 | ⚠️  生成所有表数据 | ✅ 只生成需要的模块数据 |
| 模板生成 | ⚠️  固定模板 | ✅ 根据模块动态生成 |
| 项目大小 | ❌ ~500KB, 51表 | ✅ ~50-300KB, 10-40表 |
| 启动速度 | ❌ 慢 | ✅ 快 |
| 维护复杂度 | ❌ 高 | ✅ 低 |
| 行业适配 | ❌ 需手动调整 | ✅ 自动选择方案 |

---

## 🚀 实施计划

### 第一步: 更新 Agent

1. 更新 `website_planner.md`:
   - 添加"读取 enabled_modules.txt"步骤
   - 添加"模块感知的内容规划"逻辑
   - 更新数据库设计部分

2. 更新 `website_developer.md`:
   - 添加"读取 modules_config.yaml"步骤
   - 实现模块化 SQL 生成逻辑
   - 实现动态模板生成逻辑

### 第二步: 创建新 Command

创建全新的 `/auto-website` 命令:
- 整合8个Phase的完整流程
- 集成模块选择逻辑
- 使用 create_project_modular.py
- 完善错误处理

### 第三步: 测试验证

使用3个测试场景验证:
1. 企业官网 (corporate preset)
2. 在线商城 (ecommerce preset)
3. 教育网站 (education preset)

### 第四步: 文档完善

- 更新使用指南
- 添加故障排查
- 提供最佳实践

---

## ✅ 成功标准

1. ✅ 用户只需一行命令即可生成完整网站
2. ✅ 自动选择最合适的模块方案
3. ✅ 生成的代码只包含需要的模块
4. ✅ 所有测试自动通过
5. ✅ 项目体积减少 60%+
6. ✅ 生成速度提升 50%+
7. ✅ 代码质量保持高标准

---

## 📝 总结

新系统将实现:

**完全自动化**: 从需求分析到最终交付,一个命令完成
**模块化架构**: 只生成需要的功能,避免冗余
**智能选择**: 根据行业自动选择最佳方案
**高质量输出**: AI规划 + 代码生成 + 自动测试
**易于维护**: 清晰的模块边界,简化后续维护

**核心优势**:
- 🚀 10分钟生成一个专业网站
- 🎯 完美适配新西兰中小企业
- 💪 20个模块涵盖所有常见需求
- ✨ AI驱动的内容和图片生成
- 🔧 完全可定制和扩展
